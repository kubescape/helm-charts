name: 02-E2E Test helm chart
on:
  workflow_dispatch:
    inputs:
      BRANCH:
        description: 'helm chart branch name'
        required: false
        default: 'main'
        type: string
      TESTS_BRANCH:
        description: 'tests branch name'
        required: false
        default: 'master'
        type: string
      KS_BRANCH:
        required: false
        default: 'release'
        type: string
        description: 'kubescape branch name'

jobs:
  dispatch-e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.E2E_DISPATCH_APP_ID }}
          private-key: ${{ secrets.E2E_DISPATCH_APP_PRIVATE_KEY }}
          owner: armosec
          repositories: shared-workflows

      - name: Dispatch Helm E2E to private repo
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          DISPATCH_REPO: armosec/shared-workflows
          DISPATCH_EVENT: e2e-test-trigger
          ENVIRONMENT: production
          TESTS_GROUPS: HELM_CHARTS_E2E_KUBESCAPE
          SYSTESTS_BRANCH: ${{ inputs.TESTS_BRANCH }}
          IN_CLUSTER_CHART_BRANCH: ${{ inputs.BRANCH }}
          KS_BRANCH: ${{ inputs.KS_BRANCH }}
          CHARTS_NAME: kubescape-operator
          CHARTS_REPO: ${{ github.repository }}
        run: |
          payload=$(cat <<JSON
          {
            "event_type": "${DISPATCH_EVENT}",
            "client_payload": {
              "github_repository": "${GITHUB_REPOSITORY}",
              "environment": "${ENVIRONMENT}",
              "tests_groups": "${TESTS_GROUPS}",
              "systests_branch": "${SYSTESTS_BRANCH}",
              "in_cluster_chart_branch": "${IN_CLUSTER_CHART_BRANCH}",
              "ks_branch": "${KS_BRANCH}",
              "charts_name": "${CHARTS_NAME}",
              "charts_repo": "${CHARTS_REPO}"
            }
          }
          JSON
          )

          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${DISPATCH_REPO}/dispatches" \
            -d "$payload"
