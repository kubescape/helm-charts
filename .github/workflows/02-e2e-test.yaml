name: 02-E2E Test helm chart
on:
  workflow_dispatch:
    inputs:
      BRANCH:
        description: 'helm chart branch name'
        required: false
        default: 'main'
        type: string
      TESTS_BRANCH:
        description: 'tests branch name'
        required: false
        default: 'master'
        type: string
      KS_BRANCH:
        required: false
        default: 'release'
        type: string
        description: 'kubescape branch name'

jobs:
  dispatch-e2e-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Set dispatch start time
        id: dispatch-start
        run: echo "start_time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> "$GITHUB_OUTPUT"

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.E2E_DISPATCH_APP_ID }}
          private-key: ${{ secrets.E2E_DISPATCH_APP_PRIVATE_KEY }}
          owner: armosec
          repositories: shared-workflows

      - name: Dispatch Helm E2E to private repo
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          DISPATCH_REPO: armosec/shared-workflows
          DISPATCH_EVENT: e2e-test-trigger
          ENVIRONMENT: production
          TESTS_GROUPS: HELM_CHARTS_E2E_KUBESCAPE
          SYSTESTS_BRANCH: ${{ inputs.TESTS_BRANCH }}
          IN_CLUSTER_CHART_BRANCH: ${{ inputs.BRANCH }}
          KS_BRANCH: ${{ inputs.KS_BRANCH }}
          CHARTS_NAME: kubescape-operator
          CHARTS_REPO: ${{ github.repository }}
        run: |
          payload=$(cat <<JSON
          {
            "event_type": "${DISPATCH_EVENT}",
            "client_payload": {
              "github_repository": "${GITHUB_REPOSITORY}",
              "environment": "${ENVIRONMENT}",
              "tests_groups": "${TESTS_GROUPS}",
              "systests_branch": "${SYSTESTS_BRANCH}",
              "in_cluster_chart_branch": "${IN_CLUSTER_CHART_BRANCH}",
              "ks_branch": "${KS_BRANCH}",
              "charts_name": "${CHARTS_NAME}",
              "charts_repo": "${CHARTS_REPO}"
            }
          }
          JSON
          )

          curl -L -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${DISPATCH_REPO}/dispatches" \
            -d "$payload"

      - name: Wait for shared-workflows run and stream logs
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          DISPATCH_REPO: armosec/shared-workflows
          START_TIME: ${{ steps.dispatch-start.outputs.start_time }}
          MAX_WAIT_SECONDS: 5400
          POLL_SECONDS: 20
        run: |
          set -euo pipefail
          echo "Looking for repository_dispatch run in ${DISPATCH_REPO} after ${START_TIME}"

          deadline=$(( $(date +%s) + MAX_WAIT_SECONDS ))
          run_id=""
          while [ $(date +%s) -lt $deadline ]; do
            run_id=$(gh api "repos/${DISPATCH_REPO}/actions/runs?event=repository_dispatch&per_page=20" \
              --jq '.workflow_runs | map(select(.created_at >= "'"$START_TIME"'")) | sort_by(.created_at) | last | .id // empty')
            if [ -n "$run_id" ]; then
              break
            fi
            echo "No run found yet, sleeping..."
            sleep "$POLL_SECONDS"
          done

          if [ -z "$run_id" ]; then
            echo "Timed out waiting for workflow run to start."
            exit 1
          fi

          echo "Found run id: $run_id"
          while [ $(date +%s) -lt $deadline ]; do
            status=$(gh api "repos/${DISPATCH_REPO}/actions/runs/${run_id}" --jq '.status')
            conclusion=$(gh api "repos/${DISPATCH_REPO}/actions/runs/${run_id}" --jq '.conclusion // "null"')
            html_url=$(gh api "repos/${DISPATCH_REPO}/actions/runs/${run_id}" --jq '.html_url')
            echo "Run status: ${status}, conclusion: ${conclusion}"
            echo "Run URL: ${html_url}"

            if [ "$status" = "completed" ]; then
              echo "Shared workflow completed. Streaming logs..."
              gh run view "$run_id" --repo "$DISPATCH_REPO" --log
              if [ "$conclusion" != "success" ]; then
                echo "Shared workflow failed with conclusion: ${conclusion}"
                exit 1
              fi
              echo "Shared workflow succeeded."
              exit 0
            fi

            sleep "$POLL_SECONDS"
          done

          echo "Timed out waiting for workflow run to complete."
          exit 1
