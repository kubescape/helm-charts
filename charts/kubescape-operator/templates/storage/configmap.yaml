{{- $components := fromYaml (include "components" .) }}
{{- $configurations := fromYaml (include "configurations" .) }}
{{- if $components.storage.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.storage.name }}
  namespace: {{ .Values.ksNamespace }}
  labels:
    {{- include "kubescape-operator.labels" (dict "Chart" .Chart "Release" .Release "Values" .Values "app" .Values.storage.name "tier" .Values.global.namespaceTier) | nindent 4 }}
    kubescape.io/tier: "core"
# Turning "kindQueues" into variables to be referenced and customized in the values override file
data:
  config.json: |
    {
      "cleanupInterval": "{{ .Values.storage.cleanupInterval }}",
      {{- if .Values.storage.disableVirtualCRDs }}
      "disableVirtualCRDs": true,
      {{- else }}
      "disableVirtualCRDs": {{ not $configurations.virtualCrds }},
      {{- end }}
      "excludeJsonPaths": {{ .Values.configurations.excludeJsonPaths | toJson }},
      "defaultQueueLength": 100,
      "defaultWorkerCount": 2,
      "defaultMaxObjectSize": 400000,
      "queueManagerEnabled": true,
      "kindQueues": {
        "applicationprofiles": {
          "queueLength": {{ .Values.storage.kindQueues.applicationprofiles.queueLength }},
          "workerCount": {{ .Values.storage.kindQueues.applicationprofiles.workerCount }},
          "maxObjectSize": {{ .Values.storage.kindQueues.applicationprofiles.maxObjectSize }}
        },
        "containerprofiles": {
          "queueLength": {{ .Values.storage.kindQueues.containerprofiles.queueLength }},
          "workerCount": {{ .Values.storage.kindQueues.containerprofiles.workerCount }},
          "maxObjectSize": {{ .Values.storage.kindQueues.containerprofiles.maxObjectSize }}
        },
        "networkneighborhoods": {
          "queueLength": {{ .Values.storage.kindQueues.networkneighborhoods.queueLength }},
          "workerCount": {{ .Values.storage.kindQueues.networkneighborhoods.workerCount }},
          "maxObjectSize": {{ .Values.storage.kindQueues.networkneighborhoods.maxObjectSize }}
        },
        "openvulnerabilityexchangecontainers": {
          "queueLength": {{ .Values.storage.kindQueues.openvulnerabilityexchangecontainers.queueLength }},
          "workerCount": {{ .Values.storage.kindQueues.openvulnerabilityexchangecontainers.workerCount }},
          "maxObjectSize": {{ .Values.storage.kindQueues.openvulnerabilityexchangecontainers.maxObjectSize }}
        },
        "sbomsyftfiltereds": {
          "queueLength": {{ .Values.storage.kindQueues.sbomsyftfiltereds.queueLength }},
          "workerCount": {{ .Values.storage.kindQueues.sbomsyftfiltereds.workerCount }},
          "maxObjectSize": {{ .Values.storage.kindQueues.sbomsyftfiltereds.maxObjectSize }}
        },
        "sbomsyfts": {
          "queueLength": {{ .Values.storage.kindQueues.sbomsyfts.queueLength }},
          "workerCount": {{ .Values.storage.kindQueues.sbomsyfts.workerCount }},
          "maxObjectSize": {{ .Values.storage.kindQueues.sbomsyfts.maxObjectSize }}
        },
        "vulnerabilitymanifests": {
          "queueLength": {{ .Values.storage.kindQueues.vulnerabilitymanifests.queueLength }},
          "workerCount": {{ .Values.storage.kindQueues.vulnerabilitymanifests.workerCount }},
          "maxObjectSize": {{ .Values.storage.kindQueues.vulnerabilitymanifests.maxObjectSize }}
        }
      },
      {{- if .Values.storage.mtls.enabled }}
      "tlsClientCaFile": "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt",
      "tlsServerCertFile": "/etc/storage-ca-certificates/tls.crt",
      "tlsServerKeyFile": "/etc/storage-ca-certificates/tls.key",
      {{- end }}
      "serverBindPort": "{{ .Values.storage.serverPort }}"
    }
{{- end }}

